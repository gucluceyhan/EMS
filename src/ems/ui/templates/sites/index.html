{% extends "base.html" %}

{% block title %}Sites Management - GES Solar EMS{% endblock %}

{% block page_subtitle %}Sites Management{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-6 space-y-6">
  <h1 class="text-xl font-semibold">Sites Management</h1>
  
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <a href="/ui/sites/add" class="block rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-950 p-6 hover:bg-gray-50 dark:hover:bg-gray-900 text-center">
      <div class="text-3xl mb-2">‚ûï</div>
      <div class="font-semibold">Add New Site</div>
      <div class="text-sm text-gray-500 mt-1">7-step wizard to create new site</div>
    </a>
    
    <div class="block rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-950 p-6 text-center">
      <div class="text-3xl mb-2">üèóÔ∏è</div>
      <div class="font-semibold">Manage Sites</div>
      <div class="text-sm text-gray-500 mt-1">Edit existing sites and devices</div>
    </div>
    
    <div class="block rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-950 p-6 text-center">
      <div class="text-3xl mb-2">üì¶</div>
      <div class="font-semibold">Bulk Operations</div>
      <div class="text-sm text-gray-500 mt-1">Import/export, batch updates</div>
    </div>
  </div>

  <div class="bg-white dark:bg-gray-950 border border-gray-200 dark:border-gray-800 rounded-xl p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold">Sites List</h2>
      <input id="siteSearch" placeholder="Search sites..." class="text-sm bg-transparent border border-gray-200 dark:border-gray-700 rounded-md px-3 py-2" />
    </div>
    
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-800 text-white uppercase tracking-wide text-xs">
          <tr>
            <th class="px-3 py-2 text-left">Site</th>
            <th class="px-3 py-2 text-left">Status</th>
            <th class="px-3 py-2 text-left">Capacity</th>
            <th class="px-3 py-2 text-left">Devices</th>
            <th class="px-3 py-2 text-left">Last Update</th>
            <th class="px-3 py-2 text-left">Actions</th>
          </tr>
        </thead>
        <tbody id="sitesTableBody"></tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block init_js %}
loadRealSites();
initSiteSearch();
{% endblock %}

{% block scripts %}
<script>
  async function loadRealSites() {
    try {
      // Fetch real devices from API
      const response = await fetch('/ui/api/devices');
      const devices = await response.json();
      
      // Group by plant_id
      const siteMap = {};
      devices.forEach(device => {
        const plantId = device.plant_id;
        if (!plantId || plantId === 'ges-fleet') return;
        
        if (!siteMap[plantId]) {
          siteMap[plantId] = {
            id: plantId,
            name: plantId.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
            devices: [],
            status: 'online',
            capacity: 0,
            lastUpdate: new Date().toLocaleString('tr-TR')
          };
        }
        
        siteMap[plantId].devices.push(device);
        
        // Calculate capacity from inverters
        if (device.type === 'inverter') {
          const capacity = getInverterCapacity(device.make, device.model);
          siteMap[plantId].capacity += capacity;
        }
      });
      
      const sites = Object.values(siteMap);
      renderSitesTable(sites);
      
    } catch (error) {
      console.error('Error loading sites:', error);
      // Fallback to demo data
      const sites = [{ id: 'site-1', name: 'Demo Site', status: 'online', capacity: 5.0, devices: [{type: 'demo'}], lastUpdate: new Date().toLocaleString('tr-TR') }];
      renderSitesTable(sites);
    }
  }
  
  function getInverterCapacity(make, model) {
    const capacityMap = {
      'Huawei': { 'SUN2000-100KTL-M1': 0.1, 'SUN2000-215KTL-H0': 0.215 },
      'ABB': { 'PVS980-58-2000kVA-A': 2.0 },
      'SMA': { 'SUNNY TRIPOWER CORE1-50': 0.05, 'SUNNY CENTRAL 2000-EV': 2.0 },
      'Fronius': { 'SYMO-20.0-3-M': 0.02 },
      'FIMER': { 'PVS-980-58-2000kVA-A': 2.0 },
      'Power Electronics': { 'FS2800K-TL': 2.8 },
      'TBEA': { 'TB2500KTL-HV': 2.5 },
      'Sineng Electric': { 'SN3125K-30': 3.125 },
      'Growatt': { 'MAX 100KTL3-X LV': 0.1 },
      'Delta Electronics': { 'M88H-12': 0.088 },
      'GoodWe': { 'GW100K-MT': 0.1 },
      'Kstar': { 'KSG-50K-TM': 0.05 },
      'Sungrow': { 'SG125HV': 0.125 },
      'Ingeteam': { 'INGECON SUN PowerMax 185TL U M': 0.185 },
      'Solaredge': { 'SE100K': 0.1 },
      'Chint': { 'CPS SC100KTL-HV-DO/US': 0.1 },
      'TMEIC': { 'SOLAR WARE SAMURAI 2156Nh-US-480': 2.156 },
      'Omron': { 'KP100L-DD-EU': 0.1 },
      'Schneider Electric': { 'CONEXT CL-25000E': 0.025 }
    };
    return capacityMap[make]?.[model] || 0.1;
  }
  
  function renderSitesTable(sites) {
    const tbody = document.getElementById('sitesTableBody');
    if (!tbody) return;
    
    const statusBadge = (s) => {
      const colors = {
        online: 'bg-green-100 text-green-800 dark:bg-green-500/20 dark:text-green-300',
        offline: 'bg-red-100 text-red-800 dark:bg-red-500/20 dark:text-red-300',
        maintenance: 'bg-amber-100 text-amber-800 dark:bg-amber-500/20 dark:text-amber-300'
      };
      return `<span class="inline-flex px-2 py-0.5 rounded-full text-xs ${colors[s] || colors.online}">${s}</span>`;
    };
    
    tbody.innerHTML = sites.map((s, idx) => `
      <tr class="border-b border-gray-200 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-900">
        <td class="px-3 py-2 font-medium">${s.name}</td>
        <td class="px-3 py-2">${statusBadge(s.status || 'online')}</td>
        <td class="px-3 py-2">${s.capacity.toFixed(2)} MW</td>
        <td class="px-3 py-2">${Array.isArray(s.devices) ? s.devices.length : s.devices || 0}</td>
        <td class="px-3 py-2">${s.lastUpdate || 'Unknown'}</td>
        <td class="px-3 py-2">
          <button onclick="editSite('${s.id || s.name}')" class="px-2 py-1 text-xs rounded-md border border-gray-200 dark:border-gray-700">Edit</button>
          <button onclick="viewSite('${s.id || s.name}')" class="px-2 py-1 text-xs rounded-md ml-1 bg-blue-600 text-white">View</button>
          <button onclick="deleteSite('${s.id || s.name}')" class="px-2 py-1 text-xs rounded-md ml-1 bg-red-600 text-white">Delete</button>
        </td>
      </tr>
    `).join('');
  }

  // Search functionality
  function initSiteSearch() {
    const search = document.getElementById('siteSearch');
    const tbody = document.getElementById('sitesTableBody');
    if (search && tbody) {
      search.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        const rows = tbody.querySelectorAll('tr');
        rows.forEach(row => {
          const siteName = row.querySelector('td').textContent.toLowerCase();
          row.style.display = siteName.includes(query) ? '' : 'none';
        });
      });
    }
  }
  
  function editSite(siteId) {
    alert(`Edit site: ${siteId} (redirect to edit form)`);
  }
  
  function viewSite(siteId) {
    window.location.href = '/ui';
  }
  
  function deleteSite(siteId) {
    if (!confirm(`"${siteId}" sitesini silmek istediƒüinizden emin misiniz?`)) return;
    alert('Site deletion feature would be implemented here');
  }
</script>
{% endblock %}